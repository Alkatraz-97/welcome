<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>For You üíõ (MP3 version)</title>
  <style>
    :root { --bg:#0b1220; --glass: rgba(255,255,255,.08); --text:#e5e7eb; --muted:#94a3b8; --accent:#a78bfa; --warn:#fbbf24; --err:#f87171; --ok:#34d399; }
    *{box-sizing:border-box}
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: radial-gradient(1200px 800px at 10% 10%, #1f2937 0%, #0b1220 70%, #070b14 100%); color: var(--text); display: grid; place-items: center; min-height: 100vh; padding: 24px; }
    .wrap{ width:min(880px, 96vw); display:flex; flex-direction:column; gap:20px; }
    h1{ margin:0; text-align:center }
    .card{ padding:18px; background:var(--glass); border:1px solid rgba(255,255,255,.12); border-radius:16px; backdrop-filter: blur(8px) saturate(130%); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .url{ flex:1; min-width: 220px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color:var(--text) }
    .btn{ padding:10px 14px; background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.2); border-radius:12px; color:var(--text); cursor:pointer; font-weight:600 }
    .btn.primary{ background: linear-gradient(135deg, rgba(167,139,250,.35), rgba(52,211,153,.25)); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(1px) }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-size:13px }
    .slider { appearance:none; width: 140px; height: 4px; border-radius:999px; background: rgba(255,255,255,.2); outline:none }
    .slider::-webkit-slider-thumb { appearance:none; width:16px; height:16px; border-radius:50%; background:#fff; box-shadow:0 0 0 4px rgba(255,255,255,.18) }
    .note{ padding:16px; background:var(--glass); border:1px solid rgba(255,255,255,.12); border-radius:16px }
    small{ color:var(--muted) }

    /* gate */
    .gate { position: fixed; inset:0; display:none; place-items:center; background: rgba(3,6,15,.82); backdrop-filter: blur(10px); z-index: 20; }
    .panel{ width:min(520px, 92vw); padding:22px; border-radius:16px; background: var(--glass); border:1px solid rgba(255,255,255,.12) }
    .pw{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color:var(--text) }
    .err{ color:var(--err); min-height: 20px; font-size:14px }

    /* diagnostics */
    .diag{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; background: rgba(0,0,0,.35); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); color:#d1fae5 }
    .diag b{ color:#93c5fd }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.2); }
    .ok{ background: rgba(52,211,153,.15); border-color: rgba(52,211,153,.35); }
    .warn{ background: rgba(251,191,36,.15); border-color: rgba(251,191,36,.35); }
    .bad{ background: rgba(248,113,113,.15); border-color: rgba(248,113,113,.35); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Press Play üéµ</h1>

    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input id="mp3Url" class="url" placeholder="/music.mp3 or paste a direct .mp3/.m4a/.ogg/.wav URL" value="music.mp3" />
        <input id="mp3File" type="file" accept="audio/*" class="btn" style="padding:8px" />
        <button id="load" class="btn">Load</button>
        <button id="play" class="btn primary">Play</button>
        <button id="unmute" class="btn">Unmute</button>
        <button id="pause" class="btn">Pause</button>
        <button id="restart" class="btn">Restart</button>
        <label class="pill">Loop <input id="loop" type="checkbox" style="margin-left:6px"></label>
        <label class="pill">Vol <input id="vol" class="slider" type="range" min="0" max="1" step="0.01" value="0.85"></label>
      </div>
      <small>Tip: Use a local file or host an MP3 next to this page as <code>music.mp3</code>. If a URL isn‚Äôt a real audio file (e.g., YouTube/Drive viewer), browsers won‚Äôt play it.</small>
      <div style="margin-top:12px">
        <audio id="player" preload="metadata" controls style="width:100%" crossorigin="anonymous"></audio>
        <div class="row" style="margin-top:8px">
          <span class="pill">‚è±Ô∏è <span id="time">00:00 / 00:00</span></span>
          <span class="pill">üîä <span id="status">Paused</span></span>
          <span id="supportBadge" class="badge warn">checking support‚Ä¶</span>
        </div>
        <div id="audioError" class="err" role="alert"></div>
      </div>
    </div>

    <div class="card note">
      <h2>Your Note üíå</h2>
      <textarea id="note" style="width:100%; min-height: 170px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color:var(--text)">Hey love,

This little page is just for you. Press play, take a breath, and read slowly. You are my favorite feeling.

‚Äî Yours</textarea>
      <div class="hint"><small>Note loads in Morse by default.</small></div>
    </div>

    <div class="card">
      <h3 style="margin:6px 0">Diagnostics</h3>
      <div class="row" style="margin-bottom:8px">
        <button id="runTests" class="btn">Run tests</button>
        <small>Quick checks for the Morse encoder and audio setup.</small>
      </div>
      <div id="diagOut" class="diag" aria-live="polite">(no results yet)</div>
    </div>
  </div>

  <!-- Optional password gate: set PASSWORD below to enable -->
  <div id="gate" class="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="panel">
      <h3 id="gateTitle" style="margin:10px 0 8px">Enter the secret</h3>
      <p style="margin:0 0 12px; color:var(--muted)">Hint: Something only we know.</p>
      <input id="pw" class="pw" type="password" placeholder="Password" autocomplete="off" />
      <div class="err" id="pwErr"></div>
      <div class="row" style="justify-content:flex-end; margin-top: 6px">
        <button id="pwGo" class="btn primary">Unlock</button>
      </div>
    </div>
  </div>

  <script>
    // === Config ===
    const PASSWORD = ""; // e.g., "stargazer" ‚Äî leave empty to disable gate

    // === DOM ===
    const audio = document.getElementById('player');
    const mp3Url = document.getElementById('mp3Url');
    const mp3File = document.getElementById('mp3File');
    const loadBtn = document.getElementById('load');
    const playBtn = document.getElementById('play');
    const unmuteBtn = document.getElementById('unmute');
    const pauseBtn = document.getElementById('pause');
    const restartBtn = document.getElementById('restart');
    const loopChk = document.getElementById('loop');
    const vol = document.getElementById('vol');
    const timeLbl = document.getElementById('time');
    const statusLbl = document.getElementById('status');
    const supportBadge = document.getElementById('supportBadge');
    const audioError = document.getElementById('audioError');

    const note = document.getElementById('note');

    const gate = document.getElementById('gate');
    const pw = document.getElementById('pw');
    const pwGo = document.getElementById('pwGo');
    const pwErr = document.getElementById('pwErr');

    const runTestsBtn = document.getElementById('runTests');
    const diagOut = document.getElementById('diagOut');

    // === Password gate ===
    if (PASSWORD && PASSWORD.trim() !== '') {
      gate.style.display = 'grid';
      function attempt(){
        if (pw.value === PASSWORD) { gate.style.display = 'none'; setTimeout(()=> pw.value='', 50);} else { pwErr.textContent = "That's not it. Try again ‚ô•"; }
      }
      pwGo.addEventListener('click', attempt);
      pw.addEventListener('keydown', e=>{ if(e.key==='Enter') attempt(); });
    }

    // === Helper: format time
    function fmt(t){ if(!isFinite(t)) return '00:00'; const m = Math.floor(t/60).toString().padStart(2,'0'); const s = Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`; }
    function setStatus(s){ statusLbl.textContent = s; }

    // === Helper: guess if URL is real audio file
    function isLikelyAudio(url){ return /\.(mp3|m4a|ogg|wav)(?:[?#].*)?$/i.test(url || ''); }
    function isDrive(url){ return /drive\.google\.com|dropbox\.com\/s\//i.test(url || ''); }
    function isYouTube(url){ return /(?:youtu\.be\/|youtube\.com\/)/i.test(url || ''); }

    // === Player support badge
    const support = {
      mp3: !!audio.canPlayType && audio.canPlayType('audio/mpeg') !== '',
      m4a: !!audio.canPlayType && (audio.canPlayType('audio/mp4') || audio.canPlayType('audio/aac')) !== '',
      ogg: !!audio.canPlayType && audio.canPlayType('audio/ogg; codecs="vorbis"') !== '',
      wav: !!audio.canPlayType && audio.canPlayType('audio/wav') !== ''
    };
    const supTxt = `mp3:${support.mp3?'‚úîÔ∏é':'‚úñÔ∏é'} m4a:${support.m4a?'‚úîÔ∏é':'‚úñÔ∏é'} ogg:${support.ogg?'‚úîÔ∏é':'‚úñÔ∏é'} wav:${support.wav?'‚úîÔ∏é':'‚úñÔ∏é'}`;
    supportBadge.textContent = supTxt;
    supportBadge.className = 'badge ' + (support.mp3||support.m4a||support.ogg||support.wav ? 'ok' : 'bad');

    // === Wiring ===
    vol.addEventListener('input', ()=> audio.volume = +vol.value);

    function clearAudioError(){ audioError.textContent = ''; }
    function showAudioError(msg){ audioError.textContent = msg; }

    function setAudioSource(src){
      clearAudioError();
      audio.pause();
      audio.removeAttribute('src');
      while (audio.firstChild) audio.removeChild(audio.firstChild);

      const source = document.createElement('source');
      source.src = src;
      if (/\.mp3(?:[?#].*)?$/i.test(src)) source.type = 'audio/mpeg';
      else if (/\.(m4a|mp4)(?:[?#].*)?$/i.test(src)) source.type = 'audio/mp4';
      else if (/\.ogg(?:[?#].*)?$/i.test(src)) source.type = 'audio/ogg';
      else if (/\.wav(?:[?#].*)?$/i.test(src)) source.type = 'audio/wav';
      audio.appendChild(source);

      audio.load();
      setStatus('Loaded');
    }

    loadBtn.addEventListener('click', ()=>{
      const url = (mp3Url.value || '').trim();
      if (!url) return;
      if (isYouTube(url)) { showAudioError('YouTube is not a direct audio file. Use MP3 (or choose a local file).'); return; }
      if (isDrive(url)) { showAudioError('Drive/Dropbox viewer links may fail. Get a direct .mp3 link or upload the MP3 next to this page.'); }
      else if (!isLikelyAudio(url)) { showAudioError('This URL does not look like a direct audio file (.mp3/.m4a/.ogg/.wav).'); }
      setAudioSource(url);
      // Auto-try play muted
      audio.muted = true; audio.play().then(()=> setStatus('Playing (muted)')).catch(()=> setStatus('Loaded (tap Unmute/Play)'));
    });

    mp3File.addEventListener('change', ()=>{
      const f = mp3File.files?.[0];
      if (!f) return;
      const objectUrl = URL.createObjectURL(f);
      setAudioSource(objectUrl);
      audio.muted = true; audio.play().then(()=> setStatus('Playing (muted)')).catch(()=> setStatus('Loaded (tap Unmute/Play)'));
    });

    playBtn.addEventListener('click', async ()=>{
      try { await audio.play(); } catch (e) { showAudioError('Play blocked by browser. Tap Play again after loading a valid audio source.'); console.log('Play blocked', e); }
    });
    unmuteBtn.addEventListener('click', ()=>{ audio.muted = false; audio.play().catch(()=>{}); setStatus('Playing'); });
    pauseBtn.addEventListener('click', ()=> audio.pause());
    restartBtn.addEventListener('click', ()=>{ audio.currentTime = 0; audio.play().catch(()=>{}); });

    audio.addEventListener('timeupdate', ()=>{ timeLbl.textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration)}`; });
    audio.addEventListener('loadedmetadata', ()=>{ timeLbl.textContent = `${fmt(0)} / ${fmt(audio.duration)}`; clearAudioError(); });
    audio.addEventListener('play', ()=> setStatus(audio.muted ? 'Playing (muted)' : 'Playing'));
    audio.addEventListener('pause', ()=> setStatus('Paused'));
    audio.addEventListener('ended', ()=> setStatus('Ended'));
    audio.addEventListener('error', ()=>{
      let msg = 'Cannot play this source. Possible reasons: not a real audio file, blocked by host, or unsupported format.';
      const url = (mp3Url.value||'').trim();
      if (isYouTube(url)) msg = 'You pasted a YouTube page, which is not a direct audio file. Use MP3 (or choose a local file).';
      else if (isDrive(url)) msg = 'Cloud drive viewer links often block audio. Get a direct .mp3 link or upload the MP3 next to this page.';
      else if (!isLikelyAudio(url) && !audio.currentSrc.startsWith('blob:')) msg = 'The URL does not end with a known audio extension (.mp3/.m4a/.ogg/.wav).';
      showAudioError(msg);
    });

    // === Morse ===
    const MORSE = {
      'a':'.-','b':'-...','c':'-.-.','d':'-..','e':'.','f':'..-.','g':'--.','h':'....','i':'..','j':'.---','k':'-.-','l':'.-..','m':'--','n':'-.','o':'---','p':'.--.','q':'--.-','r':'.-.','s':'...','t':'-','u':'..-','v':'...-','w':'.--','x':'-..-','y':'-.--','z':'--..',
      '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
      '.':'.-.-.-', ',':'--..--', '?':'..--..', '!':'-.-.--', ':':'---...', '\'':' .----. ', '"':'.-..-.', '/':'-..-.', '(':'-.--.', ')':'-.--.-', '&':'.-...', '+':'.-.-.', '=':'-...-', '-':'-....-', '@':'.--.-.'
    };
    function encodeToMorse(text){
      return text.split('\n')
        .map(line => line.split(' ')
          .map(word => word.split('')
            .map(ch => MORSE[ch.toLowerCase()] || ch)
            .join(' '))
          .join('   '))
        .join('\n');
    }

    // === Tiny test harness ===
    function test(name, got, want){ const ok = got === want; return `${ok? '‚úÖ PASS':'‚ùå FAIL'}  ${name}\n  got : ${got}\n  want: ${want}\n`; }
    function runTests(){
      const out = [];
      out.push(test('SOS', encodeToMorse('SOS'), '... --- ...'));
      out.push(test('HELLO WORLD', encodeToMorse('HELLO WORLD'), '.... . .-.. .-.. ---   .-- --- .-. .-.. -..'));
      out.push(test('multiline', encodeToMorse('Hi\nHi'), '.... ..\n.... ..'));
      out.push(test('digits', encodeToMorse('2019'), '..--- ----- .---- ----.'));
      out.push('\nAudio support: ' + supTxt + '\nIf audio is muted on load, press Unmute once.');
      diagOut.textContent = out.join('\n');
    }
    runTestsBtn.addEventListener('click', runTests);

    // === On load: auto-load music, loop, autoplay muted; default note to Morse ===
    document.addEventListener('DOMContentLoaded', ()=>{
      // default loop + volume
      loopChk.checked = true; audio.loop = true; audio.volume = +vol.value;

      // set source from the URL field and try autoplay muted
      const url = (mp3Url.value || '').trim();
      if (url) {
        setAudioSource(url);
        audio.muted = true;
        audio.play().then(()=> setStatus('Playing (muted, looping)')).catch(()=> setStatus('Loaded (tap Unmute/Play)'));
      }

      // Set note to Morse by default and lock it to Morse-only view
      const orig = note.value;
      note.value = encodeToMorse(orig);
      // Morse-only: no toggle buttons shown (they were removed)
    });
  </script>
</body>
</html>
